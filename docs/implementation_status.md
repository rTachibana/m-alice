# 実装状況

## ✅ 完了した機能

### 基本機能
- [x] **画像の入出力**: PNG、JPG、WEBP形式の画像をアップロードし、PNG形式で処理済み画像を出力可能。
- [x] **ウォーターマークの適用**: watermarkフォルダ内の画像を動的に読み込み、可視型ウォーターマークとして適用。透過率調整や白黒反転オプション付き。
- [x] **リサイズ機能**: 画像を小、中、デフォルトのサイズにリサイズし、アスペクト比を維持。

### 画像の保存
- [x] インプット、またはドラッグ＆ドロップされた画像のファイル名を一時保持。これを元に、maliced- のプレフィックスを付与した処理結果ファイル名として使用する。

### UIの改善
- [x] **ドラッグ＆ドロップ対応**: 画像をアプリケーションにドラッグ＆ドロップして処理可能。
- [x] **クリック操作での画像選択**: 画像エリアをクリックするだけで画像選択ダイアログが開く直感的な操作を実現。
- [x] **モーダル通知**: エラーや処理完了時にモーダル通知を表示。
- [x] **出力フォルダへのアクセス**: 処理済み画像をクリックすると出力フォルダを開く機能を追加。
- [x] **設定モーダル**: サイドバーの設定ボタンから各種設定を変更可能なモーダルを実装。
- [x] **メタデータ表示機能**: 処理後の画像のメタデータ情報を表示するボタンを追加。処理完了モーダルからも詳細情報として確認可能。

### バックエンドの改善
- [x] **Python統合**: 埋め込みPython環境を使用し、ユーザーのシステムに依存しない動作を実現。
- [x] **Pythonの自動セットアップ**: 初回起動時にPython環境を自動的にダウンロード・セットアップし、Pillowなどの必要なライブラリをインストール。
- [x] **エラーハンドリング**: Pythonスクリプトの実行やファイル操作におけるエラーハンドリングを改善。
- [x] **動的ウォーターマーク読み込み**: watermarkフォルダ内のPNG/SVG画像を自動検出し、UI上で選択可能に。ファイル名の"_"はスペースに変換して表示。
- [ ] **ウォーターマークへのアウトライン付与**: フロントのHSVスライダーの値を元に、ウォーターマークにアウトラインを追加

### ノイズ付与
- [x] **不可視ノイズ**: AI学習から画像を保護するためのノイズ付与技術を実装。DCTノイズ、スペックルノイズ、ガウシアンノイズ、ショットノイズ（塩コショウノイズ）を段階的に適用可能。

### メタデータ操作
- [x] **EXIF/IPTCメタデータ**: メタデータの削除、フェイクメタデータの追加、AI学習禁止フラグの挿入機能を実装。
- [x] **メタデータ表示**: 処理前後の画像のメタデータを確認できる機能を追加。

## 🚀 今後の機能拡張計画

### 選択的保護機能
- [ ] **マスクによるノイズ制御**: 白黒マスク画像をインポートし、マスク領域のみにノイズを適用する選択的保護機能
  - 白い部分にのみノイズを適用し、黒い部分は保護する仕組み
  - これにより、画像の重要な部分だけを選択的にAI学習から保護可能に
  - マスク画像と元画像のサイズが異なる場合は自動的にリサイズして適用
- [ ] **マスク適用オプション**: 各ノイズタイプ（DCT、スペックル、ガウシアン、ショット）それぞれに対してマスク適用の有無を選択可能に
- [ ] **マスク反転機能**: マスク白黒の反転オプションを追加し、保護領域の柔軟な指定を可能に

### 高度な保護機能（将来計画）
- [ ] **インタラクティブなマスク作成**: Canvas APIを活用した直接描画によるマスク領域指定機能
  - 画像上で直接、保護したい/したくない領域をブラシツールで指定
  - ブラシサイズや硬さの調整機能
  - 消しゴムツールによるマスク修正機能
- [ ] **マスクプリセット**: 共通利用シーンに対応したマスクプリセット（顔領域、テキスト領域、中央部分など）
- [ ] **レイヤー管理システム**: マスク、ノイズ、ウォーターマークなどの処理を個別レイヤーとして管理
  - 各レイヤーの表示/非表示、不透明度調整
  - レイヤーの重ね順の変更

### 補助機能
- [ ] **QRコード埋め込み**: URLから自動生成したQRコードを画像の指定位置（四隅または中央）に配置
  - QRコードのサイズ、色、透明度のカスタマイズ
  - 作者情報やライセンス情報へのリンクなどを簡単に埋め込み可能に

## 技術的アプローチ
- マスクノイズ処理には`numpy`のマスク処理とPillowの画像合成を組み合わせて使用
- Canvas機能は、Electronと連携したHTMLのCanvas APIを活用
- レイヤー処理システムは、バックエンドとフロントエンドで状態を同期させる設計
- モジュール化された設計により、新規機能を既存のコードベースに影響少なく追加できるよう構成

## 🆕 最近の更新

### 2025年4月29日
- 画像処理後にメタデータを表示するボタンを追加し、ワンクリックでメタデータ情報を確認可能に。
- メタデータオプションが正しく機能するよう、JavaScriptのキャメルケース形式（removeMetadata）からPythonのスネークケース形式（remove_metadata）への変換を実装。
- メタデータ表示の不具合を修正し、特にJSON形式のデータが1文字ずつ分割される問題を解決。
- エラーメッセージの表示方法を改善し、より明確な形式でユーザーに通知するように変更。
- ComfyUIなどの生成AI由来の画像に対するメタデータ処理のエラーを修正。

### 2025年4月28日
- 画像選択ボタンを削除し、画像エリア自体をクリックすることで画像選択ダイアログを開けるように改善。
- watermarkフォルダから動的にウォーターマーク画像を読み込む機能を実装。
- ウォーターマーク選択肢にファイル名を表示する際、"_"をスペースに変換して可読性を向上。
- ロゴサイズの自動調整機能を改良し、様々な画像サイズでより適切な表示を実現。
- ノイズ付与の処理順序を最適化し、DCT→スペックル→ウォーターマーク→ガウシアン→ショットの順に適用することで効果と視覚的品質のバランスを改善。
- メタデータ操作機能（削除・偽装・AI禁止フラグ）を実装し、AIによる画像分析をメタデータレベルでも防止。

### 2025年4月27日
- 処理済み画像をクリックすると出力フォルダを開く機能を追加。
- Pythonセットアップを強化し、必要なライブラリ（Pillow, NumPy, SciPy）が自動的にインストールされるように改善。
- README.mdを更新し、Python自動セットアッププロセスとシステム要件を詳細に記載。
- オリジナルのファイル名を保持する機能を実装：
  - ドラッグ＆ドロップされたファイル名を変数に保存
  - ファイル選択ダイアログから選択したファイル名も正しく保持
  - 処理後のファイル名に「maliced-」プレフィックスを付加
  - UIのファイル名表示も元のファイル名を正確に反映
- ノイズレベルのテキスト表示を8段階（Lv.1〜Lv.8）に改良し、直感的な強度選択を実現。
- 設定保存機能を強化：
  - ノイズタイプ（ガウシアン、DCT、スペックル、ショット）の選択状態を保存
  - ロゴ位置設定（ランダム・左上・右上・左下・右下）の保存と読み込み
  - 起動時に前回の設定を自動的に復元
- ロゴ機能の改良：
  - 四隅（左上・右上・左下・右下）への配置オプションを追加
  - 位置をランダムにする設定も維持
  - ロゴサイズを画像の短辺の20%に自動調整
  - 小さな画像ではロゴの過剰な拡大を防止する機能を追加
- エラーハンドリングを強化し、画像処理や設定保存時の問題を適切にユーザーに通知。
- アプリケーションのパッケージング設定を追加し、electron-builderを使用した配布用ビルド機能の準備を開始。

## 📦 ビルド・配布計画（未実装）
- [ ] **Windows向けインストーラー**: electron-builderを使用したNSISインストーラーの作成
- [ ] **Mac向けDMGパッケージ**: macOS用の配布パッケージの作成
- [ ] **Linux向けAppImage**: Linux用の配布パッケージの作成
- [ ] **自動更新機能**: 新バージョン検出・ダウンロード機能の実装
- [ ] **クロスプラットフォーム対応の強化**: 各OS固有の機能・パスの適切な処理

## 💡 備考
- すべての主要機能（ウォーターマーク、リサイズ、ノイズ付与、メタデータ操作）が完全に実装されました。
- 今後の更新では、安定性の向上とクロスプラットフォーム対応の強化に注力します。