# M-Alice 技術仕様書

## 1. 概要

M-Alice（Malice）は、イラスト画像に対して、AIによる再学習・模倣・トレース（特にi2i / ControlNet）を抑制するための軽量・ローカル完結型の画像防衛ツールです。SNSやポートフォリオ投稿時の画像保護を主眼に置いており、自身の絵をAI学習から守りたいイラストレーターや趣味で絵を描く方を対象としています。

Windows および macOS 向けに開発されており、完全ローカル実行（ネット接続不要）で利用可能です。

### 1.1 対象ユーザー

- イラストを趣味または職業で描いている人
- 自身の絵をAI学習から守りたいが、行動に移せていない層
- Glazeが重すぎて使えないユーザー
- 日本語で完結したツールを求める層

### 1.2 入出力形式

- 入力形式：PNG / JPG / WEBP（明示的に制限）
- 出力形式：
  - PNG（デフォルト）：完全な品質と互換性優先
  - WebP可逆圧縮（オプション）：効率的なファイルサイズと完全な防御効果を両立
- 変換前後の画像をGUI上で左右に表示（Before / After）

### 1.3 商品提供形式

| 項目                  | 機能制限          | 有料版（500円）      |
|----------------------|------------------|-----------------------|
| 使用回数             | 5回まで           | 無制限                 |
| 透過率の自由設定     | ×（60%固定）     | ○                     |
| 独自画像のWM使用     | ×                | ○（PNG / SVG）        |
| ネット接続           | 不要（完全ローカル） | 不要                  |

## 2. システムアーキテクチャ

### 2.1 技術スタック

- **フロントエンド**: Electron (HTML/CSS/JavaScript)
- **バックエンド**: Python
- **画像処理ライブラリ**: Pillow, NumPy, SciPy
- **パッケージ管理**: npm (JavaScript), pip (Python)

### 2.2 アプリケーション構造

```
M-Alice/
├── build/                 # ビルド関連ファイル
│   └── icons/             # アプリケーションアイコン
├── python/                # Python埋め込み環境
├── src/                   # ソースコード
│   ├── backend/           # Pythonバックエンド
│   │   └── noise/         # ノイズ処理モジュール
│   ├── input/             # 入力画像の一時保存ディレクトリ
│   ├── logo/              # ロゴファイル
│   ├── main/              # Electronメインプロセス
│   ├── output/            # 処理済み画像の出力ディレクトリ
│   ├── renderer/          # Electronレンダラープロセス
│   └── watermark/         # ウォーターマーク[画像省略]
└── tests/                 # テストコード
```

## 3. 主要機能

### 3.1 画像処理機能

#### 3.1.1 基本機能

- 画像の選択（ファイル選択またはドラッグ&ドロップ）
- 処理済み画像の保存
- 出力ディレクトリの表示

#### 3.1.2 画像加工機能

- **リサイズ処理**:
  - デフォルトサイズ（変更なし）
  - 中サイズ（最大寸法を制限）
  - 小サイズ（最大寸法を制限）

- **ノイズ適用**:
  - 8段階のノイズレベル（Lower～Chaos）
  - モジュール化された複数のノイズタイプ：
    - DCTノイズ（離散コサイン変換）
    - ガウシアンノイズ
    - スペックルノイズ
    - ショットノイズ（塩コショウノイズ）
    - ヒマラヤンショットノイズ
    - マスタードノイズ

- **マスタードプリセット**:
  - 特殊なノイズ設定の組み合わせを提供
  - DCTノイズ、マスタードノイズ、ガウシアンノイズを特定の順序で適用

- **ウォーターマーク**:
  - 有効/無効の切り替え
  - 種類の選択（No AI, All Rights Reservedなど）
  - 透明度の調整
  - 白黒反転オプション

- **ロゴ配置**:
  - 配置位置の選択（左上、右上、左下、右下、ランダム）
  - 画像の短辺の20%をロゴの最大サイズとする設計

- **メタデータ処理**:
  - メタデータの削除
  - 偽メタデータの追加
  - No AIフラグの追加

### 3.2 技術的詳細

#### 3.2.1 ノイズ適用アルゴリズム

- **DCTノイズ**: 
  - 離散コサイン変換を使用して高周波成分を強調/減衰
  - 画像の周波数領域の特性を変更

- **ガウシアンノイズ**:
  - 画像全体に通常分布のノイズを追加
  - ノイズレベルに応じて強度を調整

- **スペックルノイズ**:
  - 乗法的ノイズで画素値にランダムな変動を加える
  - 画像の細かいテクスチャに影響

- **ショットノイズ**:
  - 塩コショウノイズとも呼ばれる点状のノイズ
  - ランダムに画素値を極端に変更

- **ヒマラヤンノイズ**:
  - ピンク岩塩と黒コショウを意識した点状のノイズ
  - ランダムに、かつより自然に画素値を極端に変更

- **マスタードノイズ**:
  - マスタードをモチーフにした複合ノイズ
  - 黄色と茶色の複数の色調を使用したショットノイズ
  - 軽いスペックルノイズを組み合わせて粒子感を表現
  - 視覚的に特徴的なノイズパターンでAI学習をより効果的に妨害

#### 3.2.2 ノイズモジュールの構造

- モジュール化されたノイズ処理アーキテクチャ
- 各ノイズタイプは個別のPythonモジュールとして実装
- `noise/__init__.py`を通じて統一されたインターフェースを提供
- 新しいノイズタイプの追加が容易

#### 3.2.3 ウォーターマーク処理

- 画像の中央に配置
- アルファチャンネルを持つPNG形式
- 透明度調整による可視性の制御
- 白黒反転オプションによる背景に応じた最適化
- HSVスライダーによるアウトラインの追加

#### 3.2.4 メタデータ処理

- EXIF、IPTC、XMPメタデータの操作
- オリジナルメタデータの削除
- カスタムメタデータの追加
- AI生成フラグの操作

## 4. 通信アーキテクチャ

### 4.1 プロセス間通信

- **Electron IPC (Inter-Process Communication)**: メインプロセスとレンダラープロセス間の通信
  - `ipcMain`と`ipcRenderer`を使用
  - 非同期通信による効率的なデータ交換

### 4.2 Python連携

- **子プロセス実行**: Node.jsの`child_process.spawn()`を使用
- **JSONシリアライズ**: 処理オプションをJSON形式で受け渡し
- **ファイルベースの入出力**: 一時ファイルを介したデータ交換

## 5. 環境構築・初期化

### 5.1 Python環境

- 組み込みPython環境（Windows用）のダウンロードと展開
- pip（Pythonパッケージマネージャー）のインストール
- 必要なライブラリ（Pillow, NumPy, SciPy）の自動インストール
- ポータブル設計：システムのPythonには依存せず、バンドルされたPython環境のみを使用

#### 5.1.1 パッケージとモジュールの管理

- 絶対インポートパスを使用したモジュール参照
- コマンドライン実行とライブラリ呼び出しの両方に対応する設計
- バックエンドモジュールの明確な責任分担：
  - `process.py`：画像処理のメインフロー
  - `watermark_processor.py`：ウォーターマーク処理
  - `metadata_processor.py`：メタデータ操作
  - `image_resizer.py`：リサイズ処理
  - `logo_processor.py`：ロゴ配置
  - `noise/`：モジュール化されたノイズ処理

### 5.2 入出力ディレクトリ

- アプリケーション起動時に入力/出力ディレクトリの存在確認
- 未作成の場合は自動作成

### 5.3 開発環境

- 開発用依存関係の管理（requirements-dev.txt）
- テスト環境と本番環境の分離
- ポータブルPython環境との連携

## 6. 設定管理

- ユーザー設定のJSON形式での保存
- デフォルト設定の提供
- アプリケーション再起動時の設定復元

## 7. エラーハンドリング

- 画像処理エラーの検出と通知
- ファイル入出力エラーの処理
- Pythonプロセスの異常終了の検出
- 依存ライブラリの欠落に対する適切な処理

## 8. 拡張性

- 新しいノイズタイプの追加
  - noiseディレクトリに新モジュールを追加
  - __init__.pyに関数をエクスポート
- カスタムウォーターマークのサポート
- 処理オプションの拡張
- 将来的なエフェクト機能の追加（スタブ関数を用意）

## 9. 制限事項

- サポートされる画像形式: PNG, JPEG, WebP
- 大きなサイズの画像処理時のメモリ使用量
- 処理時間はノイズレベルと画像サイズに依存
- SciPyに依存するノイズ処理（環境によって機能が制限される可能性）

## 10. 将来の拡張予定

- バッチ処理モードの追加
- 処理履歴の保存と再利用
- イテレーション処理機能（同一画像に複数回の処理を適用）
- マスクによるノイズ制御（選択的保護機能）
- QRコード埋め込み機能
- 未実装のエフェクト:
  - モアレパターン
  - 選択的ブラー
  - カメラノイズ
  - フィルムグレイン
  - アダプティブシャープニング
  - JPEGアーティファクト