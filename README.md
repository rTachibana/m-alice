# 画像保護ツール「m-Alice」仕様書

## 🎯 目的
イラスト画像に対して、AIによる再学習・模倣・トレース（特にi2i / ControlNet）を抑制するための軽量・ローカル完結型の画像防衛ツールを開発する。SNSやポートフォリオ投稿時の画像保護を主眼に置く。

---

## 🖥️ 対象ユーザー
- イラストを趣味または職業で描いている人
- 自身の絵をAI学習から守りたいが、行動に移せていない層
- Glazeが重すぎて使えないユーザー
- 日本語で完結したツールを求める層

---

## 💻 プラットフォーム
- Windows / macOS（Electron + Python構成）
- 完全ローカル実行（ネット接続不要）

※ Linuxは将来的に対応検討、スマホ版は保留

---

## 📁 入出力
- 入力形式：PNG / JPG / WEBP
- 出力形式：PNG（推奨）または JPG
- 変換前後の画像をGUI上で左右に表示（Before / After）

---

## 🔧 機能一覧

### ✅ 1. 電子透かし（不可視ノイズ）
- DCTノイズ：JPEG圧縮に強い
- ベイヤーパターン擾乱：AIに誤認させやすい
- 色相微変調：人間にわからない色ズレを加える
- ノイズ強度調整可能（UIスライダー）

### ✅ 2. ウォーターマーク（可視型）
- 「AI学習禁止」「無断転載禁止」などのテンプレートを用意（SVG）
- 透過率変更可能（試用版は固定60%、有料版で任意）
- 配置パターン：全体透過レイヤー形式（固定）
- 有料版では独自画像アップロード対応（PNG / SVG）

### ✅ 3. メタデータ操作
- EXIF / IPTC / XMP メタ情報の削除
- 任意のフェイクメタ情報を追加（例：「Generated by MS Paint」）

### ✅ 4. リサイズ（学習抑止用）
- オプションとして、意図的に小サイズへリサイズ可能（OFFがデフォルト）
- リサイズ方式は総ピクセル数を基準とし、アスペクト比を維持
- リサイズ選択肢：
  - 小（推奨）：約500x500相当（総ピクセル数25万px以下、SD1.5防衛）
  - 中：約768x768相当（総ピクセル数約58万px以下、SDXL防衛）
  - 無し（オリジナル解像度維持）
- SNS投稿時の画質には影響あり（警告表示）

---

## 💰 試用版・有料版の違い

| 項目                  | 試用版           | 有料版（500円）      |
|----------------------|------------------|-----------------------|
| 使用回数             | 5回まで           | 無制限                 |
| 透過率の自由設定     | ×（60%固定）     | ○                     |
| 独自画像のWM使用     | ×                | ○（PNG / SVG）        |
| ネット接続           | 不要（完全ローカル） | 不要                  |

※ 注意：この価格設定は思想的配慮によるものであり、
商業プロジェクトで同等機能を開発・販売する場合には
**3,000円以上の正当な対価を求められるべき性質の機能構成**を含んでいます。

---

## 🛠️ 技術構成

- フロント：Electron（HTML + JS）
  - バージョン：Electron 25.0.0
  - Node.js バージョン：16.17.0
- バックエンド：Python（Pillow / NumPy / その他）
  - Python バージョン：3.12
  - 依存ライブラリ：
    - Pillow
    - NumPy
    - piexif
    - exiftool
- ポータブル版Pythonの自動インストール（zipファイルはpythonディレクトリ内に格納済）
- ノイズ処理：NumPyでのピクセル操作 + DCT
- ウォーターマーク合成：Pillow + SVG → PNG変換
- メタデータ処理：piexif / exiftool
- リサイズ：Pillowでの明示的変換、総ピクセル数制御＋アスペクト比維持

---

## 🐍 Python Embeddable Package のインストール

このツールでは、Python Embeddable Package (v3.12.10) を使用しています。以下の手順で、必要なPython環境をセットアップできます。

### 方法 1: ツール内の自動セットアップ機能を使用
1. アプリケーションを起動します。
2. 初回起動時、または「Install Python」ボタンをクリックすると、適切なPython環境が自動的にセットアップされます。

### 方法 2: コマンドラインでの手動ダウンロード
以下のコマンドを使用して、Python Embeddable Package をダウンロードし、`python/` ディレクトリに配置してください。

#### Windows 64bit
```bash
curl -o python-3.12.10-embed-amd64.zip https://www.python.org/ftp/python/3.12.10/python-3.12.10-embed-amd64.zip
```

#### Windows 32bit
```bash
curl -o python-3.12.10-embed-win32.zip https://www.python.org/ftp/python/3.12.10/python-3.12.10-embed-win32.zip
```

#### Windows ARM64
```bash
curl -o python-3.12.10-embed-arm64.zip https://www.python.org/ftp/python/3.12.10/python-3.12.10-embed-arm64.zip
```

### 方法 3: 手動ダウンロード
1. [Python公式サイト](https://www.python.org/downloads/release/python-31210/) から適切なバージョンのEmbeddable Packageをダウンロードします。
2. ダウンロードしたZIPファイルを解凍し、`python/` ディレクトリに配置してください。

---

これらの手順に従うことで、Python環境が正しくセットアップされます。問題が発生した場合は、`logs/test_results.log` を確認してください。

---

## 🛠️ 初回起動時のセットアップ

m-Aliceは初回起動時に必要なPython環境とライブラリを自動的にセットアップします。このプロセスは以下の手順で行われます：

1. **Python埋め込み版のダウンロードと展開**
   - アプリケーションはPython埋め込み版を自動的にダウンロードし、`python/` ディレクトリに展開します。

2. **pipのインストール**
   - Python環境にpip（Pythonパッケージマネージャー）をインストールします。

3. **必要なライブラリのインストール**
   - Pillow（PIL）など、アプリケーションが必要とするPythonライブラリを自動的にインストールします。

このセットアップは完全に自動化されており、ユーザーが手動で操作する必要はありません。セットアップ中に問題が発生した場合は、エラーメッセージが表示されますので、ログを確認してください。

セットアップが完了すると、アプリケーションは通常通り動作します。

---

## 🛠️ 現状の実装状況

### 基本UI
- Before/After画像表示エリアを実装しました
- 処理開始ボタンと画像選択ボタンを実装しました
- 画像未選択時は処理ボタンが非活性化されます
- ドラッグ＆ドロップでの画像選択に対応しています
- エラーや処理完了などの通知にモーダルウィンドウを使用しています
- ノイズ強度調整用のスライダーを実装しました
- ウォーターマークの有効/無効を切り替えるトグルスイッチを実装しました

### 入出力機能
- 入力画像は `src/input` ディレクトリに一時ファイルとして保存されます
- 出力画像は `src/output` ディレクトリに保存され、ファイル名に `maliced-` が付加されます
- オリジナルのファイル名が表示・保持されます
- 画像再アップロード時のキャッシュ回避処理を実装しています
- OS依存のパス問題に対応し、Windows/Mac/Linuxで動作するよう実装しています

### Python Embeddable Package のセットアップ
- 起動時にPython Embeddable Package (v3.12.10) を自動的にダウンロード・展開します
- ダウンロード後、`python312.zip` を含む不要なファイルは自動的に削除されます
- セットアップ中はローディングモーダルが表示され、進捗状況を通知します

### ウォーターマーク機能
- ウォーターマーク画像は `src/watermark/` ディレクトリに格納されています
  - 例: `all_rights_reserved.png`, `no_ai.png`
- ユーザーはUIからウォーターマークを選択可能です
- ウォーターマークの適用は `process.py` 内の `apply_watermark` 関数で処理されます（実装予定）

### 現在の開発状況
- フロントエンドのUI実装が完了しました
- バックエンドのPython処理スクリプト（process.py）は未実装です
- 次のステップとして、Python処理スクリプトの実装と、ElectronからPythonスクリプトの呼び出しを行います

### テスト状況
- テストスクリプトは `tests/` ディレクトリに格納されます
  - `test_process.py`: Pythonバックエンドのテスト
  - `renderer.test.js`: フロントエンドのテスト
- テスト結果は `logs/test_results.log` に記録されます

---

## 🔍 最新テスト結果

最新のテスト結果は以下のログファイルに記録されています：

```
logs/test_results.log
```

ログファイルを参照して、詳細なテスト結果を確認してください。

